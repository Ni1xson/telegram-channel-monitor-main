# Telegram Channel Monitor

🔍 **Система мониторинга каналов Telegram** с гибкой фильтрацией сообщений.

## 🚀 Возможности

### 📝 Гибкая система фильтров
- **Содержит** - поиск любого из ключевых слов
- **Точное совпадение** - поиск точных слов  
- **Все слова** - все ключевые слова должны присутствовать
- **Фраза** - поиск точной фразы
- **Регулярные выражения** - для продвинутых пользователей
- **Не содержит** - исключение сообщений с определенными словами

### 📢 Мониторинг каналов
- Подключение к реальному аккаунту через User API
- Мониторинг до 50 каналов одновременно
- Автоматическое обнаружение новых сообщений
- Поддержка публичных и приватных каналов

### 🎯 Уведомления
- Отправка в выбранные чаты/каналы
- Настраиваемый формат уведомлений
- Включение времени, ссылок, форматирования
- Поддержка HTML и Markdown

### 🤖 Удобная админка
- Telegram бот для управления
- Интуитивные меню и клавиатуры
- Управление фильтрами, каналами, настройками
- Статистика и мониторинг работы

## 🛠 Установка и настройка

### 1. Требования
- Python 3.9+
- Telegram аккаунт
- API ключи Telegram

### 2. Установка зависимостей
```bash
cd telegram-channel-monitor
pip install -r requirements.txt
```

### 3. Настройка
1. Скопируйте `.env.example` в `.env`
2. Заполните необходимые параметры (`TELEGRAM_API_ID`, `TELEGRAM_API_HASH`, `BOT_TOKEN`, `ADMIN_USER_ID` и др.):

```env
# Получите на https://my.telegram.org
TELEGRAM_API_ID=ваш_api_id
TELEGRAM_API_HASH=ваш_api_hash

# Получите у @BotFather
BOT_TOKEN=токен_вашего_бота

# Ваш Telegram ID
ADMIN_USER_ID=ваш_id
```

### 4. Получение API ключей

#### User API (для мониторинга)
1. Перейдите на https://my.telegram.org
2. Войдите в аккаунт
3. Перейдите в "API development tools"
4. Создайте приложение
5. Скопируйте `api_id` и `api_hash`

#### Bot API (для админки)  
1. Напишите @BotFather в Telegram
2. Создайте нового бота: `/newbot`
3. Выберите имя и username бота
4. Скопируйте токен бота

#### Ваш ID
1. Напишите @userinfobot
2. Скопируйте ваш ID

### 5. Запуск
Для запуска используйте скрипт в зависимости от операционной системы:

- **Linux/macOS**: `./run.sh`
- **Windows**: `run.bat`

Если сессия пользователя ещё не создана, скрипт автоматически запустит
консольную авторизацию. После успешного входа все возможности админ-бота
останутся без изменений.

### 6. Тестирование
Для запуска тестов необходимы библиотеки `telethon`, `aiogram`, `aiosqlite`,
`pytest` и `pytest-asyncio`. Все они уже перечислены в `requirements.txt`.

```bash
pip install -r requirements.txt
pytest
```

## 📖 Использование

### Первый запуск
1. Запустите `run.sh` (Linux/macOS) или `run.bat` (Windows). При отсутствии
   сессии будет предложено пройти авторизацию через консоль.
2. Найдите вашего админ-бота в Telegram
3. Отправьте `/start` для начала работы

### Управление фильтрами
1. "📝 Управление фильтрами" → "➕ Добавить фильтр"
2. Введите название фильтра
3. Укажите ключевые слова через запятую
4. Выберите тип логики
5. Настройте параметры (регистр, порядок слов)

### Добавление каналов
1. "📢 Управление каналами" → "➕ Добавить канал"  
2. Введите username канала (например: @news_channel)
3. Убедитесь, что подписаны на канал

### Настройка уведомлений
1. "🎯 Целевые чаты" → "➕ Добавить чат"
2. Введите ID чата (полученный у @userinfobot, он может быть вида `-100...` — это корректный ID) или перешлите сообщение из него
3. Убедитесь, что бот состоит в этом чате или канале

### Управление аккаунтом
- `/login` — вход в пользовательский аккаунт
- `/logout` — выход из аккаунта
Статус авторизации отображается в `/status`.
Дополнительно откройте раздел «👤 User клиент» в меню бота:
- «Проверить сессии» покажет список файлов `.session` и их статус;
- «Удалить сессию» позволит удалить выбранный файл;
- «Авторизоваться через консоль» запустит скрипт `scripts/cli_login.py`, и
  данные нужно вводить в консоли сервера.

### Сводка после включения мониторинга
После активации мониторинга бот пришлёт личное сообщение со списком
активных каналов, целевых чатов и фильтров. В конце будет приведён
короткий пример работы первого фильтра.

## 🏗 Архитектура

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   User Account  │───▶│  Message Engine  │───▶│  Target Chat    │
│   (Telethon)    │    │   (Filtering)    │    │ (Notifications) │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                       │                       ▲
         ▼                       ▼                       │
┌─────────────────┐    ┌──────────────────┐              │
│   Admin Bot     │───▶│  SQLite Database │──────────────┘
│   (Aiogram)     │    │   (Settings)     │
└─────────────────┘    └──────────────────┘
```

## 🔧 Структура проекта

```
telegram-channel-monitor/
├── config/           # Конфигурация
├── database/         # Работа с БД
├── admin_bot/        # Админ-бот (Aiogram)
├── monitor/          # Клиент мониторинга (Telethon)
├── utils/            # Утилиты
└── main.py          # Главный файл
```

## ⚙️ Утилиты

Модуль `utils` содержит набор вспомогательных функций. При формировании уведомлений важно экранировать HTML или Markdown-разметку.

```python
from utils import escape_html, escape_markdown
```

Импортируйте эти функции и применяйте их при составлении текста сообщений, чтобы избежать ошибок форматирования.

## 🛡 Безопасность


- Все токены хранятся в переменных окружения
- База данных зашифрована SQLite
- Валидация всех пользовательских данных
- Ограничения на количество фильтров и каналов
- Проверка прав доступа к админке

## 📊 Возможности фильтрации

### Типы логики
- `contains` – сообщение содержит любое из ключевых слов. Пример: `скидка, акция` найдёт «Сегодня скидка!».
- `exact` – точное совпадение слова без учёта частей. Пример: ключ `btc` совпадёт только с «btc».
- `all_words` – в тексте присутствуют все указанные слова. Пример: `купить, btc` → «купить btc сейчас».
- `phrase` – совпадение полной фразы с сохранением порядка. Пример: `купить btc`.
- `regex` – поиск по регулярному выражению, например `\d+% скидка`.
- `not_contains` – сообщение не должно содержать указанных слов. Пример: исключить посты с `реклама`.

### Настройки
- Учет регистра (case-sensitive)
- Важность порядка слов
- Максимальная длина сообщения
- Формат уведомлений

## 🤝 Поддержка

При возникновении проблем:
1. Проверьте логи в файле `telegram_monitor.log`
2. Убедитесь в правильности настроек в `.env`
3. Проверьте права доступа бота к чатам
4. Убедитесь, что подписаны на мониторируемые каналы

### Troubleshooting

1. Проверьте `telegram_monitor.log` на наличие ошибок
2. Убедитесь, что Telethon-сессия авторизована
3. Отправьте боту команду `/status` или выберите «📊 Статистика» в меню,
   чтобы проверить текущее состояние. Бот покажет, авторизован ли
   пользовательский клиент и доступны ли каналы.
   При неуспешной авторизации появится сообщение «❌ Отключен».
   Если какой-либо канал недоступен, бот сообщит «❌ Канал недоступен».
4. В режиме DEBUG файл `telegram_monitor.log` содержит строки о пропущенных
   сообщениях. Логи «Пропуск сообщения из канала ...» и
   «Сообщение ... не прошло фильтры» помогают понять причину пропуска.

## 📝 Лицензия

MIT License - свободное использование и модификация.

## 🐧 Автоматическая установка на Linux сервер

Для автоматического запуска бота как службы (запустил и забыл):

### Быстрая установка:
```bash
# Скачайте проект и перейдите в папку
cd telegram-channel-monitor-main

# Запустите установку (требуются права root)
sudo ./install_server.sh
```

### Что делает установка:
- ✅ Создает службу systemd для автозапуска
- ✅ Настраивает логирование в папку `logs/`
- ✅ Запускает бота в фоновом режиме
- ✅ Автоматически перезапускает при сбоях

### Управление ботом:
```bash
# Проверить статус
systemctl status telegram-monitor

# Посмотреть логи в реальном времени
journalctl -u telegram-monitor -f

# Посмотреть логи из файла
tail -f logs/bot.log

# Остановить бота
systemctl stop telegram-monitor

# Запустить бота
systemctl start telegram-monitor

# Перезапустить бота
systemctl restart telegram-monitor

# Переустановить службу
sudo ./install_server.sh
```

### Автоматические функции:
- 🔄 **Самовосстановление сессии** - при потере авторизации
- 💾 **Резервное копирование** - каждые 5 минут
- ❤️ **Heartbeat** - уведомления о работе раз в сутки
- ⚠️ **Уведомления** - при критических ошибках
- 🔄 **Автоперезапуск** - при падении процесса

### Мониторинг на сервере:
```bash
# Проверить что служба активна
systemctl is-active telegram-monitor

# Посмотреть последние ошибки
journalctl -u telegram-monitor --since "1 hour ago" | grep ERROR

# Проверить использование ресурсов
ps aux | grep main.py
```
#   t e l e g r a m - c h a n n e l - m o n i t o r - m a i n  
 